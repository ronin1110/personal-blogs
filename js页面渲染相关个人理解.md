# js页面渲染相关

## 渲染的流程

我们直接进到渲染的流程，一些域名解析，tcp连接之类的，在之前总结过，

**解析会生成两棵树，dom树和css树**

首先假使我们已经收到了一个html文件，我们就会从head标签开始逐行解析代码，解析的过程中会不如果遇到link标签，就会向服务器请求css文件，又因为请求css是异步的，所以解析不会停，遇到多个link也会都请求，遇到script标签的时候，就会停止解析，等待js文件执行完毕，然后接着 解析，开始进入body部分，浏览器会根据解析的数据，更新dom树和css树，遇到img标签也是同css文件一样，异步请求，解析结束，会得到一颗dom树，还有一颗css树，根据这两棵树，会生成一颗渲染树，再到渲染的部分，浏览器会对渲染树中每个节点计算它的位置（flow），然后附加上样式（paint），之后才会交由绘制模块绘制出来。

## 重排（又叫回流reflow）和重绘（repaint）的问题

上面有提到过，我们在形成渲染书之后会有排列元素位置和样式的阶段，我们在改变dom树结构的时候，就会触发重排和冲绘（因为paint基于Dom树），而我们如果只是改变样式，只会触发重绘，因为Dom结构没有变，

### 减少重绘和重排的方法

【CSS】使用 `visibility` 替换 `display`

【CSS】避免 `table` 布局。对于 `Render Tree` 的计算通常只需要遍历一次就可以完成，但是 `table` 布局需要计算多次，通常要花 3 倍于等同元素的时间，因此要避免。

【JS】避免频繁做 `width`、`height` 等会触发回流的操作。

【JS】操作 DOM 的时候，如果是添加 DOM 节点，可以将所有节点都在 JS 中操作完毕，再进行渲染（一次性）



## 提高页面渲染的速度

### css相关

用css动画替代js模拟动画好处：不占用js主线程；可以利用硬件加速；浏览器可以对动画做优化，（会出现卡顿）

出现卡顿的原因就是页面会频繁触发重排和重绘，减少动画元素对其他元素的影响，

一般多用transform属性来实现动画：transform属性不触发repaint，因为transform由GPU控制，支持硬件加速

### js相关

1. 将js文件，放在\</body\>之前，js会阻塞解析渲染进程

2. 使用h5的anysc属性

   ```html
   　　<script src = "test.js"  anysc></script>
   　　//加载脚本时不阻塞页面渲染
   　　//使用这个属性的脚本中不能调用document.write方法
   　　//可以只写属性名，不写属性值。写法如上
   　　//H5新增属性
   　　//脚本在下载后立即执行，同时会在window的load事件之前执行，所以有可能出现脚本执行顺序被打乱的情况
   ```

3. 使用html的defer属性

   ```html
   <script src = "test.js" defer></script>
   	//加载脚本时不阻塞页面渲染　　
   	//使用这个属性的脚本中不能调用document.write方法　　
   	//可以只写属性名，不写属性值。写法如上　　
   	//H4属性　　
   	//脚本在页面解析完之后，按照原本的顺序执行，同时会在document的DOMContentLoaded之前执行
   ```

4. 避免重复操作Dom元素

### 其他

1. 资源压缩与合并。　　　　
   HTML代码压缩：压缩在文本中有意义，而在HTML中不需要的字符。比如，空格、制表符、换行符，还有一些其他意义的字符，如HTML注释也可以被压缩。
   CSS代码压缩：删除无效的代码和css语义合并。
   JS的压缩和紊乱：使用在线网站压缩、使用html-minifier工具、使用uglifyjs2进行压缩。
   文件合并：将多个js/css小文件合并为一个文件，减少网络请求次数。
2. 浏览器缓存(之前写过blog)
3. CDN预解析（内容分发）
4. DNS预解析（域名转ipv4预解析）



