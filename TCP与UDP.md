# TCP与UDP

## TCP/IP网络模型

计算机与网络设备之间的互相通讯要基于一种相同的规则，这种规则就称之协议

TCP/IP协议是各类协议族的总称，比如：TCP,UDP,IP,FTP,HTTP,ICMP,SMTP都属于TCP/IP族内的协议

TCP/IP网络模型是互联网的基础，这些协议可以分为四层

- 应用层：负责向用户提供应用程序，比如HTTP，FTP，Telnet，DNS，smtp等，
- 传输层：对报文进行重组，并以TCp和UDp的格式封装报文，向两个主机之间的不同进程通信提供服务
- 网络层：使用无连接的网际协议 IP 和许多种路由选择协议，将运输层的报文段进行分组，还有选择合适的路由，
- 数据链路层：负责封装和解封IP报文，发送和接受ARP/RARP报文等

![img](https://image.fundebug.com/2019-03-21-01.png)

![img](https://img-blog.csdn.net/20160825152622511)



### 每层做了什么

物理层--数据链路层--网络层--传输层--应用层

总的来说协议层数越往上，越靠近用户，越往下，越靠近硬件

### 物理层

两个不同的计算机想要实现通讯，那么，就需要组网，那么组网急需要通过最基本的电气特性发送高低电压，分别来表示0和1，也就是0和1组成的比特流

### 数据链路层：

上面物理层是单纯的比特流，所以没有意义，然后就需要规定多少位的比特位是一组，也就是我们说的帧，

**数据链路层的作用**就是规定了电信号的分组方式，



以太网协议

- 一组信号组成一一个数据包，叫做帧
- 每一个数据帧包括了head和data部分



| head                                                         | data                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| head包括：（固定18个字节）<br />发送者（源地址，mac地址）6个字节<br />接受者（目标地址，MAC地址）6个字节<br />数据类型：6个字节 | data包括：（最短46字节，最高1500字节）<br />数据包的具体内容 |

帧的长度范围：

- 最短：head长度18字节+data最小46字节 = 64字节
- 最短：head长度18字节+data最大1500字节 = 1518字节

超过最大限制就要分片发送。



mac地址：每块网卡出厂时都被烧制上一个世界唯一的mac地址，长度为48位2进制，通常由12位16进制数表示（前六位是厂商编号，后六位是流水线号）

有了mac地址，由于以太网协议，我们可以通过广播的形式通讯了

### 网络层：

上面说到可以通过广播的形式通讯，问题是，世界上的互联网是由一个个的局域网组成的，如果要实现广播通讯，就需要给所有的及其发送信息，这是灾难，所以需要一种协议来区分计算机所处的子网（广播域），

**mac地址当然不能用，他只和厂商有关**

所以要引入网络地址。

#### ip协议

- 规定网络地址的协议就叫做ip协议，定义的地址叫做ip地址，网络地址用32位来表示
- 范围0,0,0,0 -> 255,255,255,255
- 通常表示是4段十进制数，192.168.1.1

**子网掩码**：将IP地址分为网络地址还有主机地址

ip地址中的网络位在掩码中用1表示，主机位用0表示，掩码的作用只是区分，



优点：避免了广播风暴还有地址浪费



#### ARP协议

我们在之前说到计算机通过mac地址，然后广播方式发送自己的信息，但是我们得知道，目标的mac，首先我们是知道目标的地址的，然后我们通过ip地址，广播发送一个数据包，数据包有目标计算机的ip地址还有自己的mac地址和ip地址，然后通过分同子网还是不同子网做出不同反应，总之是一直到目标计算机收到数据包，然后发现是自己的ip，就把自己的mac地址发送会源计算机，这样院计算机就知道了目标计算机的mac地址。

**arp协议功能：广播的方式发送数据包，获取目标主机的mac地址**



#### ICMP协议（网络控制报文）

前面说了ip协议不能保证数据的到达目标计算机，所以保证目标到达的工作由ICMP协议来做

当传送IP数据包发生错误－－比如主机不可达，路由不可达等等，ICMP协议将会把错误信息封包，然后传送回给主机。给主机一个处理错误的机会.

用到ICMP的工具主要是ping 还要tracert

### 传输层

上面我们说到，我们已经可以通过链路层mac地址找到主机，通过网络层ip定位到局域网，那么当多个程序都在通讯的时候呢，我们如何区分是那个程序在通讯呢，我们就是通过端口来区分通讯的程序

端口的作用就是，建立端口到端口的通讯

传输层有两种协议：TCP和UDP

#### TCP

tcp也是一种协议，作用就是在信息段上套上一个TCP首部，里面有源端口和目标端口，序号，确认号等，还有用于三次握手和四次挥手的字段

![img](https://img2018.cnblogs.com/blog/1447456/201809/1447456-20180915153730548-2121981757.png)

##### tcp通讯的三次握手

1. 第一次，客户端发送syn包（seq = j）,然后进入SYN_SENT状态，等待服务器应答；SYN：同步序列编号
2. 第二次，服务器收到客户端的syn包，就得先确认这个ack包（ack = j+1），同时自己也需要发送一个SYN包（seq = k），即syn包加同时服务器进入SYN_RECV状态
3. 第三次，客户端收到服务器发过来的ack+syn包，然后自己向服务器发送确认包ack（ack = k+1），发送完毕后，客户端和服务器端都进入了ESTABLISHED状态（tcp连接建立），完成三次握手
4. ![img](https://image.fundebug.com/2019-03-21-04.png)

##### tcp通讯的四次挥手

客户端或者服务器都可以请求断开连接，我们默认客户端想请求断开

1. 第一次：客户端向服务器发送连接释放报文：FIN = 1，seq = u ，并停止发送数据，进入FIN-WAIT-1状态，等待服务器的响应
2. 第二次：服务器收到客户端的释放连接的请求，服务器端先发送确认ACK = 1 报文ack = u+1,seq = v,这样之后，服务器进入CLOSE-WAIT状态，客户端到服务器的链接断开，在客户端收到服务器的确认信息后，就会进入FIN-WAIT-2状态，等待服务器释放连接的报文，这个阶段，服务器可以传信息到客户端，客户端不传信息到服务器
3. 第三次，当服务器信息传输完毕后，会发送连接释放信息，（FIN = 1，ACK = 1，序号seq = w, 确认号ack = u+1）服务器进入LAST-ACK状态，等待客户端的最终确认
4. 第四次：客户端收到服务器的释放消息后，发送确认信息（ACK = 1，seq = u+1， ack = w+1），客户端进入TIME-wait状态，客户端这时候还没有释放tcp连接，等一个2MSL后才会进入close状态，（为了保证最后的ACk报文可以到服务器）

![img](https://image.fundebug.com/2019-03-21-06.png)

#### UDP

​	UDP协议全称是用户数据报协议，在网络中它与TCP协议一样用于处理数据包，是一种无连接的协议。在OSI模型中，在第四层——传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。

特点：

1. 面向无连接的，

   在发送端，应用层将数据传递给传输层的 UDP 协议，UDP 只会给数据增加一个 UDP 头标识下是 UDP 协议，然后就传递给网络层了

   在接收端，网络层将数据传递给传输层，UDP 只去除 IP 报文头就传递给应用层，不会任何拼接操作，

2. 有单播，多播，广播的区别

   UDP 不止支持一对一的传输方式，同样支持一对多，多对多，多对一的方式，也就是说 UDP 提供了单播，多播，广播的功能。

3. UDP是面向报文的：
   发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付IP层。UDP对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。因此，应用程序必须选择合适大小的报文

4. 不可靠性：

   因为是不建立连接，想发就发，而且不备份，也不关心文件的送达情况，文件完整性也会在网络不好时出现丢包的情况，

#### 对比

|              | UDP                                        | TCP                                    |
| :----------- | :----------------------------------------- | -------------------------------------- |
| 是否连接     | 无连接                                     | 面向连接                               |
| 是否可靠     | 不可靠传输，不使用流量控制和拥塞控制       | 可靠传输，使用流量控制和拥塞控制       |
| 连接对象个数 | 支持一对一，一对多，多对一和多对多交互通信 | 只能是一对一通信                       |
| 传输方式     | 面向报文                                   | 面向字节流                             |
| 首部开销     | 首部开销小，仅8字节                        | 首部最小20字节，最大60字节             |
| 适用场景     | 适用于实时应用（IP电话、视频会议、直播等） | 适用于要求可靠传输的应用，例如文件传输 |